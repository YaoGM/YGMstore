---
title: 操作系统实验一(题目1) 
typora-root-url: ..
date: 2022-10-2 18:37:02
index_img: 
category:
- 操作系统

---


实验一 （题目一）
<!--more-->

<hr>
<h3 id="简要"><a href="#简要" class="headerlink" title="简要"></a>简要</h3><ul>
<li>笔者的虚拟机装的是Ubuntu</li>
<li>安装vim,make,gcc</li>
<li>执行insmod命令时要用管理权限，sudo insmod mod</li>
<li>task_struct的state这个变量不知道是怎么回事，我的编译会出错，错误内容是没有这个模块成员？？？(哪个坏家伙把state换了)， 改成_ _state就可以了</li>
<li>以下附上本实验要用的task_struct成员，其中comm指进程名称,mm用于区分是否是内核线程<br><img src="/img/os/1.png" srcset="/img/loading.gif" lazyload><img src="/img/os/2.png" srcset="/img/loading.gif" lazyload> <img src="/img/os/3.png" srcset="/img/loading.gif" lazyload> <img src="/img/os/4.png" srcset="/img/loading.gif" lazyload> <img src="/img/os/5.png" srcset="/img/loading.gif" lazyload> <img src="/img/os/6.png" srcset="/img/loading.gif" lazyload></li>
</ul>
<hr>
<h3 id="模块一"><a href="#模块一" class="headerlink" title="模块一"></a>模块一</h3><p>按照书上说明做即可<br><img src="/img/os/10.png" srcset="/img/loading.gif" lazyload><br><img src="/img/os/7.png" srcset="/img/loading.gif" lazyload></p>
<hr>
<h3 id="模块二"><a href="#模块二" class="headerlink" title="模块二"></a>模块二</h3><p><strong>这里重点提示一下下</strong>，父节点的children节点和子节点的sibling节点，他们的关系是父节点的children节点与子节点的sibling节点构成了一个循环链表，所以求兄弟节点的if语句就是去掉children这个头节点，不然会有乱码<br><img src="/img/os/8.png" srcset="/img/loading.gif" lazyload><br><img src="/img/os/9.png" srcset="/img/loading.gif" lazyload><br><img src="/img/os/11.png" srcset="/img/loading.gif" lazyload></p>
<hr>
<h3 id="附代码"><a href="#附代码" class="headerlink" title="附代码"></a>附代码</h3><p>模块1</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;linux/init.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;linux/module.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;linux/kernel.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;linux/sched/signal.h&gt;</span></span><br><br><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title">print_kernel_thread_init</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">task_struct</span> *p= <span class="hljs-literal">NULL</span>;<br>    <span class="hljs-built_in">printk</span>(<span class="hljs-string">&quot;module1 start&quot;</span>);<br>    for_each_process(p)&#123;<br>    <span class="hljs-keyword">if</span>(p-&gt;mm==<span class="hljs-literal">NULL</span>)<br>    &#123;<br>        <span class="hljs-built_in">printk</span>(<span class="hljs-string">&quot;%s\t%d\t%d\t%ld\t%d\n&quot;</span>,p-&gt;comm,p-&gt;pid,p-&gt;parent-&gt;pid,p-&gt;__state,p-&gt;prio);<br>    &#125;<br>    &#125;<br>    <span class="hljs-built_in">printk</span>(<span class="hljs-string">&quot;finish&quot;</span>);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title">print_kernel_thread_exit</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-built_in">printk</span>(<span class="hljs-string">&quot;module1 exit&quot;</span>);<br>&#125;<br><br><span class="hljs-built_in">module_init</span>(print_kernel_thread_init);<br><span class="hljs-built_in">module_exit</span>(print_kernel_thread_exit);<br><span class="hljs-built_in">MODULE_LICENSE</span>(<span class="hljs-string">&quot;GPL&quot;</span>);<br></code></pre></td></tr></table></figure>
<p>Makefile</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs vim"><span class="hljs-number">1</span> obj-<span class="hljs-keyword">m</span> :=mod1.<span class="hljs-keyword">o</span><br><span class="hljs-number">2</span> mod1-objs :=module1.<span class="hljs-keyword">o</span><br><span class="hljs-number">3</span> KDIR :=/lib/modules/$(<span class="hljs-keyword">shell</span> uname -r)/build<br><span class="hljs-number">4</span> PWD :=$(<span class="hljs-keyword">shell</span> <span class="hljs-keyword">pwd</span>)<br><span class="hljs-number">5</span> default:<br><span class="hljs-number">6</span>         <span class="hljs-keyword">make</span> -C $(KDIR) M=$(PWD) modules<br><span class="hljs-number">7</span> clean:<br><span class="hljs-number">8</span>         <span class="hljs-keyword">make</span> -C $(KDIR) M=$(PWD) clean<br><span class="hljs-number">9</span> <br></code></pre></td></tr></table></figure>
<p>模块2</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;linux/init.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;linux/module.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;linux/kernel.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;linux/pid.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;linux/types.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;linux/sched.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;linux/list.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;linux/moduleparam.h&gt;</span></span><br><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> pid;<br><span class="hljs-built_in">module_param</span>(pid,<span class="hljs-type">int</span> ,<span class="hljs-number">0644</span>);<br><br><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title">print_fml_init</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">pid</span>* npid;<br>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">task_struct</span>* task;<br>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">task_struct</span>* parent;<br>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">task_struct</span>* children;<br>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">task_struct</span>* nsibling;<br>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">list_head</span>* p;<br><br>    npid=<span class="hljs-built_in">find_get_pid</span>(pid);<br>    task=<span class="hljs-built_in">pid_task</span>(npid,PIDTYPE_PID);<br>    <span class="hljs-built_in">printk</span>(<span class="hljs-string">&quot; mod1_1 start\n&quot;</span>);<br><br>    <span class="hljs-comment">//parent</span><br>    <span class="hljs-built_in">printk</span>(<span class="hljs-string">&quot;Parent:\n&quot;</span>);<br>    parent=task-&gt;parent;<br>    <span class="hljs-built_in">printk</span>(<span class="hljs-string">&quot;%s\t %d\t %d\n&quot;</span>,parent-&gt;comm,parent-&gt;pid,parent-&gt;__state);<br><br>    <span class="hljs-comment">//sibling</span><br>    <span class="hljs-built_in">printk</span>(<span class="hljs-string">&quot;Sibling:\n&quot;</span>);<br>    <span class="hljs-built_in">list_for_each</span>(p,&amp;(task-&gt;sibling))&#123;<br>	<span class="hljs-keyword">if</span>(p!=&amp;(task-&gt;parent-&gt;children))&#123;<br>	    nsibling=<span class="hljs-built_in">list_entry</span>(p,<span class="hljs-keyword">struct</span> task_struct,sibling);<br>	    <span class="hljs-built_in">printk</span>(<span class="hljs-string">&quot;%s\t %d\t %d\n&quot;</span>,nsibling-&gt;comm,nsibling-&gt;pid,nsibling-&gt;__state);<br>	&#125;<br>    &#125;<br><br>    <span class="hljs-comment">//children</span><br>    <span class="hljs-built_in">printk</span>(<span class="hljs-string">&quot;Children:\n&quot;</span>);<br>    <span class="hljs-built_in">list_for_each</span>(p,&amp;(task-&gt;children))&#123;<br>	children=<span class="hljs-built_in">list_entry</span>(p,<span class="hljs-keyword">struct</span> task_struct,sibling);<br>	<span class="hljs-built_in">printk</span>(<span class="hljs-string">&quot;%s\t %d\t %d\n&quot;</span>,children-&gt;comm,children-&gt;pid,children-&gt;__state);<br>    &#125;<br>    <br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title">print_fml_exit</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span></span>&#123;<br>    <span class="hljs-built_in">printk</span>(<span class="hljs-string">&quot;mod1_1 exit\n&quot;</span>);<br>&#125;<br><br><span class="hljs-built_in">module_init</span>(print_fml_init);<br><span class="hljs-built_in">module_exit</span>(print_fml_exit);<br><br><span class="hljs-built_in">MODULE_LICENSE</span>(<span class="hljs-string">&quot;GPL&quot;</span>);<br></code></pre></td></tr></table></figure>
<p>Makefile</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs vim"><span class="hljs-number">1</span> obj-<span class="hljs-keyword">m</span> :=mod1_1.<span class="hljs-keyword">o</span><br><span class="hljs-number">2</span> mod1_1-objs :=module1_1.<span class="hljs-keyword">o</span><br><span class="hljs-number">3</span> KDIR :=/lib/modules/$(<span class="hljs-keyword">shell</span> uname -r)/build<br><span class="hljs-number">4</span> PWD :=$(<span class="hljs-keyword">shell</span> <span class="hljs-keyword">pwd</span>)<br><span class="hljs-number">5</span> default:<br><span class="hljs-number">6</span>         <span class="hljs-keyword">make</span> -C $(KDIR) M=$(PWD) modules<br><span class="hljs-number">7</span> clean:<br><span class="hljs-number">8</span>         <span class="hljs-keyword">make</span> -C $(KDIR) M=$(PWD) clean            <br></code></pre></td></tr></table></figure>


<p class="note note-success">author: YaoGuangMing 2022-HDU</p>
<p class="note note-warning">转载请标明出处！</p>